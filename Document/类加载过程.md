类文件加载过程：加载-连接（验证-准备-解析）-初始化-使用-卸载

### 1.加载

1.通过全类名获取定义此类的二进制字节流

2.将字节流所代表的静态存储结构转换成方法区的运行时数据结构

3.在内存中生成一个代表该类的class对象，作为访问方法区数据的入口

### 2.验证

**文件格式验证--元数据验证--字节码验证--符号引用验证**

文件格式验证：验证字节流是否符合class文件规范。

元数据验证：进行语义分析，保证描述的信息符合java语言规范。

字节码验证：

符号引用验证：

### 3.准备

为类变量（静态变量）分配内存并设置类变量初始值，在方法区中分配。

- jdk1.7之前类变量都放在方法区中；jdk1.7及之后，字符串常量池和静态变量都随对象一起放在堆内存中。

- 类变量在这个阶段的初始值是零值，但被final修饰的类变量会直接赋值。

### 4.解析

**符号引用：**用一组符号描述目标，可以是任何字面量，只需要无歧义的定位到目标即可，此时并不知道引用目标的实际地址。

**直接引用：**指向目标地址的指针；相对偏移量（实例变量，实例方法）；可以间接定位到目标的句柄。有了直接引用，则目标就加载到内存中了。

解析阶段将符号引用替换成直接引用。程序执行方法需要知道位置，jvm为每个类准备了一张方法表存放类中方法，当调用一个类的方法时，只需要知道方法表的偏移量就可以直接调用方法了。

### 5.初始化

执行初始化方法，是类加载的最后一步，这一步jvm才真正执行类中定义的java代码。

**何时初始化：**

1.new一个对象，读取静态变量，为静态变量赋值，调用静态方法

2.使用反射包对类进行反射调用

3.初始化一个类，如果父类没有初始化，先初始化父类

4.jvm启动时，包含main方法的类会被初始化

5.MethodHandle和VarHandle看作是轻量级反射调用，必须先使用findStaticVarHandle初始化类。

6.接口中有default的方法，如果接口的实现类初始化，这个接口需要先初始化。

### 6.卸载

卸载类就是类被垃圾回收。

**满足三个要求：**

1.该类的所有实例对象都被GC

2.该类没有在任何地方被引用

3.该类的类加载器实例被GC

jvm自带的类加载器加载的类不会被回收，自己自定义的类加载器加载的类可能被卸载。